name: Docker Image CI/CD

on:
  schedule:
    - cron: '0 0 * * *'  # ÊØèÂ§©UTC 00:00ËøêË°å
  workflow_dispatch:
    inputs:
      overflow_version:
        description: 'OverflowÁâàÊú¨Âè∑ÔºàÂèØÈÄâÔºåÈªòËÆ§‰ΩøÁî®ÊúÄÊñ∞ÁâàÊú¨Ôºâ'
        required: false
        type: string
      mirai_version:
        description: 'MiraiÁâàÊú¨Âè∑ÔºàÂèØÈÄâÔºåÈªòËÆ§‰ΩøÁî®ÊúÄÊñ∞ÁâàÊú¨Ôºâ'
        required: false
        type: string
      bouncycastle_version:
        description: 'BouncyCastleÁâàÊú¨Âè∑ÔºàÂèØÈÄâÔºåÈªòËÆ§‰ΩøÁî®1.64Ôºâ'
        required: false
        type: string
        default: '1.64'
      maven_repo:
        description: 'Maven‰ªìÂ∫ìÂú∞ÂùÄÔºàÂèØÈÄâÔºåÈªòËÆ§‰ΩøÁî®Âçé‰∏∫ÈïúÂÉèÔºâ'
        required: false
        type: string
        default: 'https://mirrors.huaweicloud.com/repository/maven'
      create_release:
        description: 'ÊòØÂê¶ÂàõÂª∫ Release'
        type: boolean
        default: false
        required: true
      force_build:
        description: 'ÊòØÂê¶Âº∫Âà∂ÊûÑÂª∫ÔºàÂøΩÁï•ÁâàÊú¨Ê£ÄÊü•Ôºâ'
        type: boolean
        default: false
        required: true

permissions:
  contents: write  # Áî®‰∫éÊõ¥Êñ∞ README ÂíåÂàõÂª∫ release
  packages: write  # Áî®‰∫éÊé®ÈÄÅ Docker ÈïúÂÉè

env:
  IMAGE_NAME: overflow
  DOCKER_HUB_REPO: ${{ vars.DOCKERHUB_USERNAME }}/overflow

jobs:
  check_versions:
    runs-on: ubuntu-latest
    outputs:
      needs_update: ${{ steps.check.outputs.needs_update }}
      overflow_version: ${{ steps.check.outputs.overflow_version }}
      mirai_version: ${{ steps.check.outputs.mirai_version }}
      bouncycastle_version: ${{ steps.check.outputs.bouncycastle_version }}
      maven_repo: ${{ steps.check.outputs.maven_repo }}
      current_overflow_version: ${{ steps.check.outputs.current_overflow_version }}
      current_mirai_version: ${{ steps.check.outputs.current_mirai_version }}
      release_date: ${{ steps.check.outputs.release_date }}
      release_url: ${{ steps.check.outputs.release_url }}
      mirai_release_date: ${{ steps.check.outputs.mirai_release_date }}
      mirai_release_url: ${{ steps.check.outputs.mirai_release_url }}
      changelog: ${{ steps.check.outputs.changelog }}
      mirai_changelog: ${{ steps.check.outputs.mirai_changelog }}
    steps:
      - name: Get latest versions
        id: check
        run: |
          # ËÆæÁΩÆÈªòËÆ§ÂÄº
          BOUNCYCASTLE_VERSION="${{ github.event.inputs.bouncycastle_version }}"
          if [ -z "$BOUNCYCASTLE_VERSION" ]; then
            BOUNCYCASTLE_VERSION="1.64"
          fi
          
          MAVEN_REPO="${{ github.event.inputs.maven_repo }}"
          if [ -z "$MAVEN_REPO" ]; then
            MAVEN_REPO="https://mirrors.huaweicloud.com/repository/maven"
          fi
          
          echo "ËÆæÁΩÆÊûÑÂª∫ÂèÇÊï∞:"
          echo "- BouncyCastleÁâàÊú¨: ${BOUNCYCASTLE_VERSION}"
          echo "- Maven‰ªìÂ∫ì: ${MAVEN_REPO}"
          
          # Â¶ÇÊûúÊ≤°ÊúâÊåáÂÆöOverflowÁâàÊú¨ÔºåÂàôËé∑ÂèñÊúÄÊñ∞ÁâàÊú¨
          if [ -z "${{ github.event.inputs.overflow_version }}" ]; then
            echo "Ëá™Âä®Ëé∑Âèñ Overflow ÊúÄÊñ∞ÁâàÊú¨"
            OVERFLOW_VERSION=$(curl -s https://api.github.com/repos/MrXiaoM/Overflow/releases/latest | jq -r '.tag_name' | sed 's/^v//')
            if [ -z "$OVERFLOW_VERSION" ] || [ "$OVERFLOW_VERSION" = "null" ]; then
              echo "::error::Êó†Ê≥ïËé∑Âèñ Overflow ÊúÄÊñ∞ÁâàÊú¨"
              exit 1
            fi
            echo "Ëé∑ÂèñÂà∞ Overflow ÊúÄÊñ∞ÁâàÊú¨: ${OVERFLOW_VERSION}"
            RELEASE_URL="https://github.com/MrXiaoM/Overflow/releases/tag/v${OVERFLOW_VERSION}"
            CHANGELOG=$(curl -s https://api.github.com/repos/MrXiaoM/Overflow/releases/latest | jq -r '.body')
            RELEASE_DATE=$(curl -s https://api.github.com/repos/MrXiaoM/Overflow/releases/latest | jq -r '.published_at')
          else
            echo "‰ΩøÁî®ÊåáÂÆöÁöÑ Overflow ÁâàÊú¨: ${{ github.event.inputs.overflow_version }}"
            OVERFLOW_VERSION=$(echo "${{ github.event.inputs.overflow_version }}" | sed 's/^v//')
            if [ -z "$OVERFLOW_VERSION" ]; then
              echo "::error::ÊåáÂÆöÁöÑ Overflow ÁâàÊú¨Âè∑Êó†Êïà"
              exit 1
            fi
            RELEASE_URL="https://github.com/MrXiaoM/Overflow/releases/tag/v${OVERFLOW_VERSION}"
            # Ëé∑ÂèñÊåáÂÆöÁâàÊú¨ÁöÑrelease‰ø°ÊÅØ
            RELEASE_INFO=$(curl -s "https://api.github.com/repos/MrXiaoM/Overflow/releases/tags/${OVERFLOW_VERSION}")
            if [ "$(echo "$RELEASE_INFO" | jq -r '.message')" = "Not Found" ]; then
              echo "::warning::Êó†Ê≥ïËé∑ÂèñÁâàÊú¨ ${OVERFLOW_VERSION} ÁöÑÂèëÂ∏É‰ø°ÊÅØ"
              CHANGELOG="ÊâãÂä®ÊåáÂÆöÁâàÊú¨ÊûÑÂª∫ÔºàÊó†Ê≥ïËé∑ÂèñÂèëÂ∏É‰ø°ÊÅØÔºâ"
              RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            else
              CHANGELOG=$(echo "$RELEASE_INFO" | jq -r '.body')
              RELEASE_DATE=$(echo "$RELEASE_INFO" | jq -r '.published_at')
            fi
          fi
          
          # Â¶ÇÊûúÊ≤°ÊúâÊåáÂÆöMiraiÁâàÊú¨ÔºåÂàôËé∑ÂèñÊúÄÊñ∞ÁâàÊú¨
          if [ -z "${{ github.event.inputs.mirai_version }}" ]; then
            echo "Ëá™Âä®Ëé∑Âèñ Mirai ÊúÄÊñ∞ÁâàÊú¨"
            MIRAI_VERSION=$(curl -s https://api.github.com/repos/mamoe/mirai/releases/latest | jq -r '.tag_name' | sed 's/v//')
            if [ -z "$MIRAI_VERSION" ] || [ "$MIRAI_VERSION" = "null" ]; then
              echo "::error::Êó†Ê≥ïËé∑Âèñ Mirai ÊúÄÊñ∞ÁâàÊú¨"
              exit 1
            fi
            echo "Ëé∑ÂèñÂà∞ Mirai ÊúÄÊñ∞ÁâàÊú¨: ${MIRAI_VERSION}"
            MIRAI_RELEASE_URL="https://github.com/mamoe/mirai/releases/tag/v${MIRAI_VERSION}"
            MIRAI_CHANGELOG=$(curl -s https://api.github.com/repos/mamoe/mirai/releases/latest | jq -r '.body')
            MIRAI_RELEASE_DATE=$(curl -s https://api.github.com/repos/mamoe/mirai/releases/latest | jq -r '.published_at')
          else
            echo "‰ΩøÁî®ÊåáÂÆöÁöÑ Mirai ÁâàÊú¨: ${{ github.event.inputs.mirai_version }}"
            MIRAI_VERSION=${{ github.event.inputs.mirai_version }}
            if [ -z "$MIRAI_VERSION" ]; then
              echo "::error::ÊåáÂÆöÁöÑ Mirai ÁâàÊú¨Âè∑Êó†Êïà"
              exit 1
            fi
            MIRAI_RELEASE_URL="https://github.com/mamoe/mirai/releases/tag/v${MIRAI_VERSION}"
            # Ëé∑ÂèñÊåáÂÆöÁâàÊú¨ÁöÑrelease‰ø°ÊÅØ
            MIRAI_RELEASE_INFO=$(curl -s "https://api.github.com/repos/mamoe/mirai/releases/tags/${MIRAI_VERSION}")
            if [ "$(echo "$MIRAI_RELEASE_INFO" | jq -r '.message')" = "Not Found" ]; then
              echo "::warning::Êó†Ê≥ïËé∑ÂèñMiraiÁâàÊú¨ ${MIRAI_VERSION} ÁöÑÂèëÂ∏É‰ø°ÊÅØ"
              MIRAI_CHANGELOG="ÊâãÂä®ÊåáÂÆöÁâàÊú¨ÊûÑÂª∫ÔºàÊó†Ê≥ïËé∑ÂèñÂèëÂ∏É‰ø°ÊÅØÔºâ"
              MIRAI_RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            else
              MIRAI_CHANGELOG=$(echo "$MIRAI_RELEASE_INFO" | jq -r '.body')
              MIRAI_RELEASE_DATE=$(echo "$MIRAI_RELEASE_INFO" | jq -r '.published_at')
            fi
          fi
          
          # Ëé∑Âèñ Docker Hub ÂΩìÂâçÁâàÊú¨
          if ! CURRENT_OVERFLOW_VERSION=$(curl -sf "https://hub.docker.com/v2/repositories/${{ env.DOCKER_HUB_REPO }}/tags/" | \
            jq -r '.results[] | select(.name != "latest") | .name' | head -n1); then
            echo "::warning::Failed to fetch Docker Hub version, assuming first build"
            CURRENT_OVERFLOW_VERSION="0.0.0"
          fi
          
          # Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÁâàÊú¨Âè∑ÔºàÂèØËÉΩÊòØÈ¶ñÊ¨°ÊûÑÂª∫Ôºâ
          if [ -z "$CURRENT_OVERFLOW_VERSION" ] || [ "$CURRENT_OVERFLOW_VERSION" == "null" ]; then
            echo "No version found in Docker Hub, assuming first build"
            CURRENT_OVERFLOW_VERSION="0.0.0"
          fi

          # ‰ªéÂΩìÂâçÁâàÊú¨‰∏≠ÊèêÂèñ Mirai ÁâàÊú¨
          if [[ "$CURRENT_OVERFLOW_VERSION" =~ -mirai\.(.*) ]]; then
            CURRENT_MIRAI_VERSION="${BASH_REMATCH[1]}"
          else
            CURRENT_MIRAI_VERSION="0.0.0"
          fi
          
          # ÊØîËæÉÁâàÊú¨
          if [ "$OVERFLOW_VERSION" != "$CURRENT_OVERFLOW_VERSION" ] || [ "$MIRAI_VERSION" != "$CURRENT_MIRAI_VERSION" ]; then
            echo "Update needed: $CURRENT_OVERFLOW_VERSION (mirai: $CURRENT_MIRAI_VERSION) -> $OVERFLOW_VERSION (mirai: $MIRAI_VERSION)"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "No update needed, current version is latest: $CURRENT_OVERFLOW_VERSION (mirai: $CURRENT_MIRAI_VERSION)"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi
          
          # ËæìÂá∫ÁâàÊú¨‰ø°ÊÅØ
          {
            echo "overflow_version=${OVERFLOW_VERSION}"
            echo "mirai_version=${MIRAI_VERSION}"
            echo "current_overflow_version=${CURRENT_OVERFLOW_VERSION}"
            echo "current_mirai_version=${CURRENT_MIRAI_VERSION}"
            echo "bouncycastle_version=${BOUNCYCASTLE_VERSION}"
            echo "maven_repo=${MAVEN_REPO}"
            echo "release_date=${RELEASE_DATE}"
            echo "release_url=${RELEASE_URL}"
            echo "mirai_release_date=${MIRAI_RELEASE_DATE}"
            echo "mirai_release_url=${MIRAI_RELEASE_URL}"
            echo "changelog<<EOF"
            echo "${CHANGELOG}"
            echo "EOF"
            echo "mirai_changelog<<EOF"
            echo "${MIRAI_CHANGELOG}"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # Ê£ÄÊü•ÁâàÊú¨Âè∑ÊòØÂê¶‰∏∫Á©∫
          if [ -z "${OVERFLOW_VERSION}" ]; then
            echo "::error::Overflow ÁâàÊú¨Âè∑‰∏çËÉΩ‰∏∫Á©∫"
            exit 1
          fi
          
          if [ -z "${MIRAI_VERSION}" ]; then
            echo "::error::Mirai ÁâàÊú¨Âè∑‰∏çËÉΩ‰∏∫Á©∫"
            exit 1
          fi
          
          if [ -z "${BOUNCYCASTLE_VERSION}" ]; then
            echo "::error::BouncyCastle ÁâàÊú¨Âè∑‰∏çËÉΩ‰∏∫Á©∫"
            exit 1
          fi
          
          echo "Using Overflow version: ${OVERFLOW_VERSION}"
          echo "Using Mirai version: ${MIRAI_VERSION}"
          echo "Using BouncyCastle version: ${BOUNCYCASTLE_VERSION}"
          echo "Using Maven repo: ${MAVEN_REPO}"

  build:
    needs: check_versions
    if: |
      needs.check_versions.outputs.needs_update == 'true' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.force_build == 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKER_HUB_REPO }}:arm64-latest
            ${{ env.DOCKER_HUB_REPO }}:arm64-${{ needs.check_versions.outputs.overflow_version }}-mirai.${{ needs.check_versions.outputs.mirai_version }}
          build-args: |
            MAVEN_REPO=${{ needs.check_versions.outputs.maven_repo }}
            OVERFLOW_VERSION=${{ needs.check_versions.outputs.overflow_version }}
            MIRAI_VERSION=${{ needs.check_versions.outputs.mirai_version }}
            BOUNCYCASTLE_VERSION=${{ needs.check_versions.outputs.bouncycastle_version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update README versions
        if: success()
        run: |
          # Êõ¥Êñ∞ÁâàÊú¨‰ø°ÊÅØ
          sed -i "s/Overflow Core: .*/Overflow Core: ${{ needs.check_versions.outputs.overflow_version }}/" README.md
          sed -i "s/Mirai Console: .*/Mirai Console: ${{ needs.check_versions.outputs.mirai_version }}/" README.md
          sed -i "s/BouncyCastle: .*/BouncyCastle: ${{ needs.check_versions.outputs.bouncycastle_version }}/" README.md
          
          # ÈÖçÁΩÆ Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Êèê‰∫§Êõ¥Êîπ
          git add README.md
          git commit -m "chore: Êõ¥Êñ∞ÁâàÊú¨‰ø°ÊÅØ [skip ci]" || echo "No changes to commit"
          git push

      - name: Create Release
        if: |
          success() && (
            github.event_name == 'schedule' ||
            (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
          )
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "arm64-${{ needs.check_versions.outputs.overflow_version }}"
          name: "[ARM64] Overflow Docker ${{ needs.check_versions.outputs.overflow_version }}"
          body: |
            üß™ **ÂÆûÈ™åÊÄß ARM64 ÊîØÊåÅÁâàÊú¨**
            
            ËøôÊòØ‰∏Ä‰∏™ÂÆûÈ™åÊÄßÁöÑÂ§öÊû∂ÊûÑÊîØÊåÅÁâàÊú¨ÔºåÊîØÊåÅ AMD64 Âíå ARM64 Êû∂ÊûÑ„ÄÇ
            
            ## ÁâàÊú¨‰ø°ÊÅØ
            
            ### Overflow
            - ÁâàÊú¨: ${{ needs.check_versions.outputs.current_overflow_version }} -> ${{ needs.check_versions.outputs.overflow_version }}
            - ÂèëÂ∏ÉÊó∂Èó¥: ${{ needs.check_versions.outputs.release_date }}
            - Release ÈìæÊé•: ${{ needs.check_versions.outputs.release_url }}
            
            ### Mirai
            - ÁâàÊú¨: ${{ needs.check_versions.outputs.current_mirai_version }} -> ${{ needs.check_versions.outputs.mirai_version }}
            - ÂèëÂ∏ÉÊó∂Èó¥: ${{ needs.check_versions.outputs.mirai_release_date }}
            - Release ÈìæÊé•: ${{ needs.check_versions.outputs.mirai_release_url }}
            
            ### ÂÖ∂‰ªñ‰ø°ÊÅØ
            - BouncyCastle: ${{ needs.check_versions.outputs.bouncycastle_version }}
            - Maven‰ªìÂ∫ì: ${{ needs.check_versions.outputs.maven_repo }}
            
            ## Docker ÈïúÂÉè
            ```bash
            # ÊúÄÊñ∞ÂÆûÈ™åÁâàÊú¨
            docker pull ${{ env.DOCKER_HUB_REPO }}:arm64-latest
            
            # Êàñ‰ΩøÁî®ÊåáÂÆöÁâàÊú¨
            docker pull ${{ env.DOCKER_HUB_REPO }}:arm64-${{ needs.check_versions.outputs.overflow_version }}-mirai.${{ needs.check_versions.outputs.mirai_version }}
            ```
            
            ## ‚ö†Ô∏è ÂÆûÈ™åÊÄßÂäüËÉΩÊèêÈÜí
            
            Ê≠§ÁâàÊú¨ÊîØÊåÅ‰ª•‰∏ãÊû∂ÊûÑÔºö
            - ‚úÖ linux/amd64Ôºàx86_64Ôºâ
            - üß™ linux/arm64ÔºàARM64/AArch64Ôºâ
            
            Â¶ÇÊûúÊÇ®Âú®‰ΩøÁî®ËøáÁ®ã‰∏≠ÈÅáÂà∞‰ªª‰ΩïÈóÆÈ¢òÔºö
            1. ËØ∑Âú® [Issues](../../issues) ‰∏≠Êä•Âëä
            2. Êèê‰æõÊÇ®ÁöÑËÆæÂ§á‰ø°ÊÅØÂíå‰ΩøÁî®Âú∫ÊôØ
            3. ÈôÑ‰∏äËØ¶ÁªÜÁöÑÈîôËØØÊó•Âøó
            
            ## Overflow Êõ¥Êñ∞ËØ¥Êòé
            
            ${{ needs.check_versions.outputs.changelog }}
            
            ## Mirai Êõ¥Êñ∞ËØ¥Êòé
            
            ${{ needs.check_versions.outputs.mirai_changelog }}
          draft: false
          prerelease: true

      - name: Update Summary
        if: success()
        run: |
          echo "Docker image updated to version ${{ needs.check_versions.outputs.overflow_version }}-mirai.${{ needs.check_versions.outputs.mirai_version }}" >> $GITHUB_STEP_SUMMARY 